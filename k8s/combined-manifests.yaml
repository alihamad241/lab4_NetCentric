apiVersion: v1
kind: PersistentVolume
metadata:
    name: postgres-pv
spec:
    capacity:
        storage: 1Gi
    accessModes:
        - ReadWriteOnce
    persistentVolumeReclaimPolicy: Retain
    storageClassName: standard
    hostPath:
        path: /mnt/data/postgres

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
    name: postgres-pvc
spec:
    storageClassName: standard
    accessModes: [ReadWriteOnce]
    resources:
        requests:
            storage: 1Gi

---
apiVersion: v1
kind: Service
metadata:
    name: postgres-service
spec:
    selector:
        app: postgres
    ports:
        - protocol: TCP
          port: 5432
          targetPort: 5432

---
apiVersion: v1
kind: ConfigMap
metadata:
    name: postgres-init
data:
    init.sql: |
        CREATE TABLE IF NOT EXISTS weather_readings (
            id BIGSERIAL PRIMARY KEY,
            station_id BIGINT,
            s_no BIGINT,
            battery_status VARCHAR(10),
            status_timestamp BIGINT,
            humidity INT,
            temperature INT,
            wind_speed INT
        );
        CREATE INDEX IF NOT EXISTS idx_station_id ON weather_readings(station_id);

---
apiVersion: apps/v1
kind: Deployment
metadata:
    name: postgres-db
spec:
    replicas: 1
    selector:
        matchLabels:
            app: postgres
    template:
        metadata:
            labels:
                app: postgres
        spec:
            initContainers:
                - name: fix-permissions
                  image: busybox
                  command: ["sh", "-c", "chown -R 999:999 /var/lib/postgresql/data"]
                  volumeMounts:
                      - name: postgres-storage
                        mountPath: /var/lib/postgresql/data
            containers:
                - name: postgres
                  image: postgres:15-alpine
                  env:
                      - name: POSTGRES_USER
                        value: "admin"
                      - name: POSTGRES_PASSWORD
                        value: "password"
                      - name: POSTGRES_DB
                        value: "weather_db"
                  volumeMounts:
                      - name: postgres-storage
                        mountPath: /var/lib/postgresql/data
                      - name: postgres-init-script
                        mountPath: /docker-entrypoint-initdb.d
            volumes:
                - name: postgres-storage
                  persistentVolumeClaim:
                      claimName: postgres-pvc
                - name: postgres-init-script
                  configMap:
                      name: postgres-init

---
# Zookeeper headless service and StatefulSet (single replica for dev)
apiVersion: v1
kind: Service
metadata:
    name: zookeeper-headless
spec:
    clusterIP: None
    selector:
        app: zookeeper
    ports:
        - port: 2181

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
    name: zookeeper
spec:
    serviceName: zookeeper-headless
    replicas: 1
    selector:
        matchLabels:
            app: zookeeper
    template:
        metadata:
            labels:
                app: zookeeper
        spec:
            containers:
                - name: zookeeper
                  image: bitnamilegacy/zookeeper:latest
                  env:
                      - name: ALLOW_ANONYMOUS_LOGIN
                        value: "yes"
                  ports:
                      - containerPort: 2181

---
# Kafka headless service + service for clients
apiVersion: v1
kind: Service
metadata:
    name: kafka-headless
spec:
    clusterIP: None
    selector:
        app: kafka
    ports:
        - port: 9092

---
apiVersion: v1
kind: Service
metadata:
    name: kafka-service
spec:
    selector:
        app: kafka
    ports:
        - protocol: TCP
          port: 9092
          targetPort: 9092

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
    name: kafka
spec:
    serviceName: kafka-headless
    replicas: 1
    selector:
        matchLabels:
            app: kafka
    template:
        metadata:
            labels:
                app: kafka
        spec:
            containers:
                - name: kafka
                  image: bitnamilegacy/kafka:3.3
                  env:
                      - name: KAFKA_BROKER_ID
                        value: "1"
                      - name: KAFKA_CFG_ZOOKEEPER_CONNECT
                        value: "zookeeper-headless:2181"
                      - name: KAFKA_CFG_LISTENERS
                        value: "PLAINTEXT://:9092"
                      - name: KAFKA_CFG_ADVERTISED_LISTENERS
                        value: "PLAINTEXT://kafka-service:9092"
                  ports:
                      - containerPort: 9092

---
# Weather station deployment (10 replicas)
apiVersion: apps/v1
kind: Deployment
metadata:
    name: weather-stations
spec:
    replicas: 10
    selector:
        matchLabels:
            app: weather-station
    template:
        metadata:
            labels:
                app: weather-station
        spec:
            containers:
                - name: station
                  image: hanine-weather-app:v3
                  imagePullPolicy: Never
                  args: ["com.netcentric.lab4.station.WeatherStation"]
                  env:
                      - name: KAFKA_BOOTSTRAP_SERVERS
                        value: "kafka-service:9092"
                      - name: STATION_ID_ENV
                        valueFrom:
                            fieldRef:
                                fieldPath: metadata.name

---
# Central station deployment
apiVersion: apps/v1
kind: Deployment
metadata:
    name: central-station
spec:
    replicas: 1
    selector:
        matchLabels:
            app: central-station
    template:
        metadata:
            labels:
                app: central-station
        spec:
            containers:
                - name: central
                  image: hanine-weather-app:v3
                  imagePullPolicy: Never
                  args: ["com.netcentric.lab4.central.CentralStation"]
                  env:
                      - name: KAFKA_BOOTSTRAP_SERVERS
                        value: "kafka-service:9092"
                      - name: DATABASE_URL
                        value: "jdbc:postgresql://postgres-service:5432/weather_db"

---
# Service to expose central station inside the cluster
apiVersion: v1
kind: Service
metadata:
    name: central-station-service
spec:
    selector:
        app: central-station
    ports:
        - protocol: TCP
          port: 8080
          targetPort: 8080

---
# Rain Detector Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
    name: rain-detector
spec:
    replicas: 1
    selector:
        matchLabels:
            app: rain-detector
    template:
        metadata:
            labels:
                app: rain-detector
        spec:
            containers:
                - name: detector
                  image: hanine-weather-app:v2
                  imagePullPolicy: Never
                  args: ["com.netcentric.lab4.processor.RainingTrigger"]
                  env:
                      - name: KAFKA_BOOTSTRAP_SERVERS
                        value: "kafka-service:9092"
